services:
  mongo:
    image: mongo:7
    container_name: mongo_data_pipeline
    ports:
      - "27017:27017"
    volumes:
      - mongo_data_pipeline:/data/db

  collector:
    build: ./collector
    depends_on:
      - mongo
    environment:
      - MONGO_URI=mongodb://mongo:27017
      - DB_NAME=pipeline_db
    command: ["node", "collect.js"]

  enrichment:
    build: ./enrichment
    depends_on:
      - mongo
    environment:
      - MONGO_URI=mongodb://mongo:27017
      - DB_NAME=pipeline_db
    command: ["node", "enrich.js"]

  etl:
    build: ./etl
    depends_on:
      - mongo
    environment:
      - MONGO_URI=mongodb://mongo:27017
      - DB_NAME=pipeline_db
      - SQLITE_PATH=/data/data.sqlite
    volumes:
      - sqlite_data:/data
    command: ["node", "etl.js"]

  api:
    build: ./api
    depends_on:
      - mongo
      - etl
    environment:
      - SQLITE_PATH=/data/data.sqlite
      - PORT=4000
    volumes:
      - sqlite_data:/data:ro
    ports:
      - "4000:4000"

  dashboard:
    build: ./dashboard
    depends_on:
      - api
    environment:
      - VITE_API_URL=http://localhost:4000
    ports:
      - "5173:5173"
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "5173"]

volumes:
  mongo_data_pipeline:
  sqlite_data: